const p=(f,e,t)=>{const r=f[e];return r?typeof r=="function"?r():Promise.resolve(r):new Promise((s,a)=>{(typeof queueMicrotask=="function"?queueMicrotask:setTimeout)(a.bind(null,new Error("Unknown variable dynamic import: "+e+(e.split("/").length!==t?". Note that variables only represent file names one level deep.":""))))})},v=(...f)=>[f[0].locale_id,[].concat(...f.map(e=>e.json))];class w extends Map{constructor(e,t,r){super(r),this.formatters=Object.entries(e.formatters).reduce((s,[a,l])=>{const n=[new Intl.Locale(t)];return e.default_locale_id&&n.push(new Intl.Locale(e.default_locale_id)),s[a]=l(n),s},{}),this.i18n=e,this.locale_id=t}createTranslator(){return this.i18n.createTranslator(this.locale_id)}t(e,t){return this.i18n.t(this.locale_id,e,t)}}const m={get(f,e,t){const[,,r,s]=e;return f.i18n.t(f.locale_id,t.k,{...r,...Object.fromEntries(Object.entries(t.o||{}).map(([a,l])=>[a,f.i18n.resolve(r,l)]))},s+1)},parse(f){const[e,t]=f.replace(/\s/g,"").split(","),r={k:e};return t&&(r.o=Object.fromEntries(new URLSearchParams(t).entries())),r}};class b{constructor(e){this.default_locale_id=e==null?void 0:e.default_locale_id,this.formatters=(e==null?void 0:e.formatters)??{},this.getters={$t:m,...e==null?void 0:e.getters},this.locales=new Map,this.nested_limit=(e==null?void 0:e.nested_limit)??3}createTranslator(e){const t=this;function r(s,a){return t.t(e,s,a)}return r.locale=this.locales.get(e),r}loadParsed(e,t){const r=new w(this,e,t);return this.locales.set(e,r),r}resolve(e,t){return t.split(/\./g).reduce((r,s)=>r&&r[s],e)}t(e,t,r={},s=0){if(s>this.nested_limit)throw new Error(`Potential circular translation, "${t}" exceeded nesting limit (${this.nested_limit})`);if(!this.locales.has(e))throw new Error(`A locale with the name of "${e}" does not exist`);const a=this.locales.get(e);if(!a.has(t))throw new Error(`The "${e}" locale does not contain a message with the key "${t}"`);let l=a.get(t);if("q"in l){const c=l.q.cardinal&&"cardinal"||l.q.ordinal&&"ordinal"||null;if(c){const o=this.resolve(r,l.q[c]);if(isNaN(Number(o))&&!Array.isArray(o))throw new Error(`A number/array value for the "${l.q[c]}" variable is required`);const d=`${t}.=${o}`;if(a.has(d))t=d;else{const u=new Intl.PluralRules(e,{type:c}),g=Array.isArray(o)?u.selectRange(...o):u.select(o);if(t=t+"."+g,!a.has(t))throw new Error(`Pluralisation failed: the "${e}" locale does not contain a message with the key "${t}"`)}l=a.get(t)}}let n;if("t"in l)n=l;else{if(!(this instanceof x)||!("o"in l))throw new Error(`Message "${t}" in the "${e}" locale has not been extracted`);const c=this.extract(l.o);a.set(t,c),n=c}let h=0,i=n.t;if(n.p===void 0)return i;for(const[c,o]of n.p){const d=c+h;let u,g;if("v"in o){g=o.v;const _=this.resolve(r,String(o.v));typeof _=="function"?u=_(a.formatters).result:u=_==null?void 0:_.toString()}else g=o.g,u=this.getters[o.g].get(a,[e,t,r,s],o.d);if(u===void 0)throw new Error(`A value for the "${g}" placeholder is required`);i=i.slice(0,d)+u+i.slice(d),h+=u.length}return i}}class x extends b{constructor(e){super(e),this.defer_extraction=(e==null?void 0:e.defer_extraction)??!0,this.placeholder_regex=(e==null?void 0:e.placeholder_regex)||/\\?{\s?(?:(?<variable>[-a-z0-9._]+)|(?:(?<getter>[$a-z0-9_]+)(?:\((?<args>[-a-z0-9()!@:%_+.~#?&/= ,]*)\))?))\s?}/gi}extract(e){const t={t:e},r=[];let s=null;for(;(s=this.placeholder_regex.exec(t.t))!==null;){if(s[0].startsWith("\\")){r.push(s[0]);continue}if(t.t=t.t.substring(0,s.index)+t.t.substring(s.index+s[0].length),this.placeholder_regex.lastIndex-=s[0].length,t.p===void 0&&(t.p=[]),s.groups.variable)t.p.push([s.index,{v:s.groups.variable}]);else{const a=s.groups.getter,l=this.getters[a];if(!l)throw new Error(`Getter "${a}" is not registered`);t.p.push([s.index,{g:a,d:l.parse(s.groups.args)}])}}return r.forEach(a=>t.t=t.t.replace(a,a.slice(1))),t}fallback(e){if(!this.default_locale_id)throw new Error("No default locale is set");let t;const r=this.locales.get(this.default_locale_id),s=Array.from(this.locales.keys()),a={};if(e){const l=new Set(Object.keys(e));for(const n of s)l.add(n);t=[...l.values()]}else t=s;for(const l of t){a[l]=[];let n;if(e)n=[...e[l]||[],this.default_locale_id];else{const i=new Intl.Locale(l).language;i!==l&&this.locales.has(i)?n=[i,this.default_locale_id]:n=[this.default_locale_id]}const h=this.locales.get(l);for(const[i]of r)if(!h.has(i))for(const c of n){const o=this.locales.get(c);if(o.has(i)){h.set(i,o.get(i)),a[l].push([i,c]);break}}}return a}load(e,t,r){return this.loadParsed(e,this.parse(t,r))}parse(e,t){const r=[];for(const[s,a]of Object.entries(e)){let l=t?t+":"+s:s,n;const h=l.indexOf("#");if(h!==-1)n={cardinal:s.substring(h+1)},l=s.substring(0,h);else{const i=l.indexOf("?");i!==-1&&(n=Object.fromEntries(new URLSearchParams(s.substring(i+1)).entries()),l=s.substring(0,i))}if(typeof a=="string")r.push([l,this.defer_extraction?{o:a}:this.extract(a)]);else if(typeof a=="object"){n&&r.push([l,{q:n}]);const i=this.parse(a);for(const[c,...o]of i)r.push([l+"."+c,...o])}}return r}}export{b as I,p as _,v as i};
